<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operation Sentinel - System Status</title>
    <link rel="stylesheet" href="css/utils.css">
</head>
<body class="bg-gray-100 font-sans h-screen flex justify-center items-center m-0">
    <main class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full text-center">
        <h1 class="text-2xl font-bold text-gray-800 m-0">Sentinel Status Board</h1>

        <div class="mt-4 p-4 rounded-lg bg-gray-100" role="status" aria-live="polite">
            <p class="text-gray-500">System Status</p>
            <p id="status-indicator" class="text-xl font-bold text-green-600">Checking...</p>
            <p id="threat-level" class="text-sm font-bold mt-4">THREAT: CHECKING</p>
        </div>

        <div class="mt-4 text-gray-500">
            <p>Directive: <span id="directive-display" class="font-bold">...</span></p>
            <p>Uptime: <span id="uptime-display">--</span>s</p>
            <button onclick="toggleCmd()" class="text-sm mt-4 text-gray-500 bg-white border-0" aria-label="Toggle Command Console">
                Security Protocol: Active
            </button>
        </div>

        <div id="cmd-console" class="hidden mt-4 bg-gray-100 p-4 rounded-lg">
            <input id="cmd-threat" placeholder="Threat Level" class="w-full p-4 mb-2 rounded-lg" aria-label="Set Threat Level">
            <input id="cmd-directive" placeholder="Directive" class="w-full p-4 mb-2 rounded-lg" aria-label="Set Directive">

            <hr class="border mt-4 mb-4">
            <h3 class="text-sm font-bold text-gray-500 mb-2">Deploy Asset</h3>
            <input id="asset-name" placeholder="Unit Name" class="w-full p-4 mb-2 rounded-lg" aria-label="Asset Name">
            <input id="asset-type" placeholder="Unit Type" class="w-full p-4 mb-2 rounded-lg" aria-label="Asset Type">
            <div class="flex justify-between">
                <input id="asset-x" placeholder="X (0-100)" type="number" min="0" max="100" class="w-full p-4 mr-2 rounded-lg" aria-label="X Coordinate">
                <input id="asset-y" placeholder="Y (0-100)" type="number" min="0" max="100" class="w-full p-4 ml-2 rounded-lg" aria-label="Y Coordinate">
            </div>
            <div class="flex justify-between mt-2">
                <input id="asset-heading" placeholder="Heading (0-360)" type="number" min="0" max="360" class="w-full p-4 mr-2 rounded-lg" aria-label="Heading">
                <input id="asset-speed" placeholder="Speed (0-10)" type="number" min="0" max="10" class="w-full p-4 ml-2 rounded-lg" aria-label="Speed">
            </div>
            <button onclick="deployAsset()" class="w-full bg-white p-4 mt-2 rounded-lg font-bold" aria-label="Deploy Asset">DEPLOY UNIT</button>

            <hr class="border mt-4 mb-4">
            <button onclick="updateStatus()" class="w-full bg-white p-4 rounded-lg font-bold" aria-label="Update Status">UPDATE STATUS</button>
        </div>

        <div class="mt-4 text-left">
            <h2 class="text-sm font-bold text-gray-800">Tactical Map</h2>
            <div class="relative w-full h-64 bg-gray-200 rounded-lg mt-2 mb-4 border overflow-hidden" id="tactical-map" aria-label="Tactical Grid Map">
                <!-- Assets rendered here -->
            </div>

            <div id="telemetry-panel" class="hidden mb-4 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800">
                <p><strong>FORCE POSTURE:</strong> <span id="posture-val">...</span></p>
                <p><strong>AVG SEPARATION:</strong> <span id="separation-val">...</span></p>
                <p><strong>PREDICTED (5m):</strong> <span id="pred-posture-val">...</span></p>
            </div>

            <h2 class="text-sm font-bold text-gray-800">Active Assets</h2>
            <div id="asset-list" class="text-sm text-gray-500 mt-2 mb-4"></div>

            <h2 class="text-sm font-bold text-gray-800">Event Log</h2>
            <div id="event-log" class="text-sm text-gray-500 mt-2 h-32 overflow-y-auto"></div>
        </div>
    </main>

    <script>
        const statusEl = document.getElementById('status-indicator');
        const threatEl = document.getElementById('threat-level');
        const directiveEl = document.getElementById('directive-display');
        const uptimeEl = document.getElementById('uptime-display');
        const logEl = document.getElementById('event-log');
        const assetEl = document.getElementById('asset-list');
        const telemetryEl = document.getElementById('telemetry-panel');
        const postureEl = document.getElementById('posture-val');
        const sepEl = document.getElementById('separation-val');
        const predPostureEl = document.getElementById('pred-posture-val');

        function toggleCmd() {
            const el = document.getElementById('cmd-console');
            el.className = el.className.includes('hidden') ? 'block mt-4 bg-gray-100 p-4 rounded-lg' : 'hidden';
        }

        async function deployAsset() {
            const name = document.getElementById('asset-name').value;
            const type = document.getElementById('asset-type').value;
            const x = document.getElementById('asset-x').value;
            const y = document.getElementById('asset-y').value;
            const heading = document.getElementById('asset-heading').value;
            const speed = document.getElementById('asset-speed').value;

            if (!name) return;

            await fetch('/api/assets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Auth-Token': 'SENTINEL-ALPHA'
                },
                body: JSON.stringify({
                    name,
                    type,
                    x: x ? parseInt(x) : undefined,
                    y: y ? parseInt(y) : undefined,
                    heading: heading ? parseInt(heading) : undefined,
                    speed: speed ? parseInt(speed) : undefined
                })
            });
            fetchStatus();
        }

        async function updateStatus() {
            const threat = document.getElementById('cmd-threat').value;
            const directive = document.getElementById('cmd-directive').value;
            if (!threat && !directive) return;

            await fetch('/api/tactical', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Auth-Token': 'SENTINEL-ALPHA'
                },
                body: JSON.stringify({
                    ...(threat && { threatLevel: threat.toUpperCase() }),
                    ...(directive && { directive: directive.toUpperCase() })
                })
            });
            fetchStatus();
        }

        async function fetchStatus() {
            try {
                const res = await fetch('/api/tactical');
                const data = await res.json();

                statusEl.textContent = data.status === 'operational' ? 'OPERATIONAL' : 'SYSTEM ALERT';
                statusEl.className = `text-xl font-bold ${data.status === 'operational' ? 'text-green-600' : 'text-red-600'}`;

                threatEl.textContent = `THREAT: ${data.threatLevel}`;
                threatEl.className = `text-sm font-bold mt-4 ${data.threatLevel === 'LOW' ? 'text-green-600' : (data.threatLevel === 'CRITICAL' ? 'text-red-600' : 'text-yellow-600')}`;

                directiveEl.textContent = data.directive;
                uptimeEl.textContent = Math.floor(data.uptime);

                if (data.logs) {
                    logEl.replaceChildren(...data.logs.slice(0, 5).map(l => {
                        const div = document.createElement('div');
                        const span = document.createElement('span');
                        span.className = 'font-bold text-xs';
                        span.textContent = `[${l.source}]`;
                        div.appendChild(span);
                        div.appendChild(document.createTextNode(' ' + l.action));
                        return div;
                    }));
                }

                if (data.assets) {
                    const mapEl = document.getElementById('tactical-map');
                    const mapChildren = data.assets.map(a => {
                        const dot = document.createElement('div');
                        dot.className = 'absolute w-2 h-2 bg-blue-600 rounded-full';
                        dot.style.left = `calc(${a.x}% - 4px)`;
                        dot.style.top = `calc(${a.y}% - 4px)`;
                        dot.title = `${a.name} (${a.type})`;

                        // Vector
                        if (a.speed > 0) {
                            const vec = document.createElement('div');
                            vec.className = 'absolute bg-red-400 origin-top-left';
                            vec.style.left = `calc(${a.x}%)`;
                            vec.style.top = `calc(${a.y}%)`;
                            vec.style.width = '2px';
                            vec.style.height = `${a.speed * 4}px`;
                            // Rotate: heading is 0=North (Up). CSS rotate 0 is Down (if using height?).
                            // If element is vertical line (height), then rotate 0 is pointing down.
                            // We want 0=Up. So rotate(180deg) is Up.
                            // If heading is 90 (East), we want Right.
                            // Current: 0 -> Down. 180 -> Up.
                            // We want: 0 -> Up. 90 -> Right.
                            // So rotate(heading + 180).
                            // Wait. Heading 0 = North (Up).
                            // CSS transform rotate(0) on a vertical div usually points down if you think of it hanging?
                            // No, it just sits there.
                            // Let's assume the div is a vertical line of height H.
                            // It goes from top to bottom.
                            // If we rotate it, it rotates around origin.
                            // If origin is top-left.
                            // We want the line to point in direction of movement.
                            // 0 deg = Up.
                            // Default vertical line points Down (positive Y).
                            // So to point Up, we need rotate(180deg).
                            // If Heading 90 (East), we need rotate(270deg) (Points Left?) No.
                            // Down -> Left is -90 or 270.
                            // Down -> Right is -90 (270).
                            // Let's verify.
                            // 0 (N) -> Need Up.
                            // 90 (E) -> Need Right.
                            // 180 (S) -> Need Down.
                            // 270 (W) -> Need Left.
                            // Default: Down (180 equivalent in our target system).
                            // So Default + X = Target.
                            // 180 + X = 0 => X = -180.
                            // 180 + X = 90 => X = -90.
                            // 180 + X = 180 => X = 0.
                            // 180 + X = 270 => X = 90.
                            // So Rotation = Heading - 180.
                            vec.style.transform = `rotate(${a.heading - 180}deg)`;
                            return [dot, vec];
                        }

                        return dot;
                    });
                    // Flatten array
                    const flatChildren = mapChildren.flat();

                    if (data.telemetry) {
                        telemetryEl.classList.remove('hidden');
                        postureEl.textContent = data.telemetry.posture;
                        sepEl.textContent = data.telemetry.avgSeparation;
                        if (data.prediction) {
                            predPostureEl.textContent = data.prediction.posture;
                        }

                        const center = document.createElement('div');
                        center.className = 'absolute w-4 h-4 border-2 border-red-500 rounded-full opacity-50';
                        center.style.left = `calc(${data.telemetry.centroid.x}% - 8px)`;
                        center.style.top = `calc(${data.telemetry.centroid.y}% - 8px)`;
                        mapChildren.push(center);
                    } else {
                        telemetryEl.classList.add('hidden');
                    }
                    mapEl.replaceChildren(...flatChildren);

                    // Update List
                    if (data.assets.length) {
                        assetEl.replaceChildren(...data.assets.map(a => {
                            const div = document.createElement('div');
                            div.className = 'flex justify-between';
                            const nameSpan = document.createElement('span');
                            nameSpan.textContent = a.name;
                            const typeSpan = document.createElement('span');
                            typeSpan.className = 'font-bold';
                            typeSpan.textContent = `${a.type || 'Unit'} [${a.x},${a.y}] v:${a.speed || 0}`;
                            div.appendChild(nameSpan);
                            div.appendChild(typeSpan);
                            return div;
                        }));
                    } else {
                        assetEl.textContent = 'No active assets';
                    }
                }
            } catch (e) {
                statusEl.textContent = 'CONNECTION LOST';
            }
        }

        fetchStatus();
        setInterval(fetchStatus, 2000);
    </script>
</body>
</html>
